<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>VisionCloud - AI Inference</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f4f9;
      }
      .container {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      h1,
      h2,
      h3,
      h4 {
        margin-top: 0;
      }

      button {
        padding: 8px 16px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
      }
      button:hover {
        background-color: #0056b3;
      }

      button.secondary {
        background-color: #6c757d;
      }
      button.secondary:hover {
        background-color: #545b62;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      input[type="file"],
      input[type="text"] {
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
      }

      /* Skip ì…ë ¥ì°½ ì „ìš© ìŠ¤íƒ€ì¼ */
      input[type="number"] {
        padding: 4px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 70px;
        text-align: center;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }
      th {
        background-color: #f8f9fa;
        font-weight: bold;
      }

      .clickable-id {
        color: #007bff;
        cursor: pointer;
        text-decoration: underline;
        font-family: monospace;
      }
      .clickable-id:hover {
        color: #0056b3;
      }

      .result-box {
        background-color: #f1f3f5;
        padding: 15px;
        margin-top: 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
      }
      .score-bar {
        background-color: #dee2e6;
        height: 10px;
        border-radius: 5px;
        margin-top: 5px;
        overflow: hidden;
      }
      .score-fill {
        background-color: #28a745;
        height: 100%;
      }

      .pagination-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .page-info {
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <h1>VisionCloud AI ë¶„ì„</h1>

    <div class="container">
      <h2>ì´ë¯¸ì§€ ë¶„ì„ ìš”ì²­</h2>
      <form id="uploadForm">
        <input type="file" id="imageFile" accept="image/*" required />
        <label
          >ëª¨ë¸ëª…:
          <input
            type="text"
            id="modelName"
            value="efficientnet_b0"
            readonly
            style="background-color: #eee"
          />
        </label>
        <button type="submit">ë¶„ì„ ì‹œì‘</button>
      </form>
      <div id="uploadResult" class="result-box" style="display: none"></div>
    </div>

    <div class="container">
      <h2>ê²°ê³¼ ìƒì„¸ ì¡°íšŒ</h2>
      <div style="display: flex; gap: 10px">
        <input
          type="text"
          id="searchIdInput"
          placeholder="ì¡°íšŒí•  ID ì…ë ¥ (ì˜ˆ: 65c...)"
          style="flex: 1; margin-bottom: 0"
        />
        <button onclick="searchById()" class="secondary">ì¡°íšŒ</button>
      </div>
      <div id="searchResult" class="result-box" style="display: none"></div>
    </div>

    <div class="container">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        "
      >
        <h2 style="margin: 0">ìµœê·¼ ë¶„ì„ ê²°ê³¼ ëª©ë¡</h2>
        <button onclick="loadList()" style="font-size: 12px" class="secondary">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div class="pagination-bar">
        <div class="page-info">
          <span id="totalCountDisplay">Total: 0</span> |
          <label
            >Skip:
            <input
              type="number"
              id="skipInput"
              value="0"
              min="0"
              onkeydown="if (event.key === 'Enter') applyManualSkip();"
            />
          </label>
          <button
            onclick="applyManualSkip()"
            class="secondary"
            style="padding: 2px 8px; font-size: 12px"
          >
            ì´ë™
          </button>
          |
          <span id="limitDisplay">Limit: 10</span>
        </div>
        <div>
          <button
            onclick="changePage(-1)"
            id="btnPrev"
            class="secondary"
            disabled
          >
            â—€ ì´ì „
          </button>
          <button
            onclick="changePage(1)"
            id="btnNext"
            class="secondary"
            disabled
          >
            ë‹¤ìŒ â–¶
          </button>
        </div>
      </div>

      <table id="listTable">
        <thead>
          <tr>
            <th>ID (í´ë¦­í•˜ì—¬ ì¡°íšŒ)</th>
            <th>ëª¨ë¸</th>
            <th>íŒŒì¼ëª…</th>
            <th>1ìˆœìœ„ ê²°ê³¼</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const API_URL = "http://localhost:8000";

      let currentSkip = 0;
      const LIMIT = 10;
      let totalCount = 0;

      // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fileInput = document.getElementById("imageFile");
          const modelName = document.getElementById("modelName").value;

          if (fileInput.files.length === 0)
            return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          formData.append("model_name", modelName);
          formData.append("top_k", 3);

          try {
            const response = await fetch(`${API_URL}/inference`, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              const err = await response.text();
              throw new Error(err);
            }

            const result = await response.json();

            displayDetailResult(result, "uploadResult");

            currentSkip = 0;
            loadList();

            fileInput.value = "";
          } catch (error) {
            alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
          }
        });

      // 2. ID ì¡°íšŒ
      async function searchById() {
        const idInput = document.getElementById("searchIdInput");
        const id = idInput.value.trim();
        if (!id) return alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
          const response = await fetch(`${API_URL}/inference/${id}`);
          if (response.status === 404)
            return alert("í•´ë‹¹ IDì˜ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
          const data = await response.json();
          displayDetailResult(data, "searchResult");
        } catch (error) {
          alert("ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
        }
      }

      // [ìˆ˜ì •ë¨] ìƒì„¸ ê²°ê³¼ í‘œì‹œ (.toFixed(2) ì ìš©)
      function displayDetailResult(data, targetElementId) {
        const targetDiv = document.getElementById(targetElementId);
        targetDiv.style.display = "block";

        let topkHtml = "<h4>Top-3 ì˜ˆì¸¡ ê²°ê³¼</h4>";
        if (data.topk && data.topk.length > 0) {
          data.topk.forEach((item, index) => {
            // [ìˆ˜ì •] ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œì‹œ (ex: 83.45%)
            const percent = (item.score * 100).toFixed(2);
            topkHtml += `
                    <div style="margin-bottom: 8px;">
                        <div style="display:flex; justify-content:space-between; font-size:14px;">
                            <span>${index + 1}. <b>${item.label}</b></span>
                            <span>${percent}%</span>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                  `;
          });
        } else {
          topkHtml += "<p>ê²°ê³¼ ì—†ìŒ</p>";
        }

        targetDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h3 style="margin-top:0;">ìƒì„¸ ë¶„ì„ ê²°ê³¼</h3>
                <button onclick="document.getElementById('${targetElementId}').style.display='none'" class="secondary" style="padding:2px 8px; font-size:12px;">ë‹«ê¸°</button>
            </div>
            <p><b>ID:</b> ${data.id}</p>
            <p><b>ëª¨ë¸:</b> ${data.model_name}</p>
            <p><b>íŒŒì¼ëª…:</b> ${data.original_filename || "ì—…ë¡œë“œ íŒŒì¼"}</p>
            <p><b>ë¶„ì„ì¼ì‹œ:</b> ${data.created_at ? new Date(data.created_at).toLocaleString() : "-"}</p>
            <hr>
            ${topkHtml}
          `;
      }

      // 3. ëª©ë¡ ì¡°íšŒ
      async function loadList() {
        try {
          document.getElementById("skipInput").value = currentSkip;

          const response = await fetch(
            `${API_URL}/inference?skip=${currentSkip}&limit=${LIMIT}`,
          );
          if (!response.ok) throw new Error("ë¡œë“œ ì‹¤íŒ¨");

          const data = await response.json();
          totalCount = data.count;

          document.getElementById("totalCountDisplay").innerText =
            `Total: ${totalCount}`;
          document.getElementById("limitDisplay").innerText = `Limit: ${LIMIT}`;

          document.getElementById("btnPrev").disabled = currentSkip === 0;
          document.getElementById("btnNext").disabled =
            currentSkip + LIMIT >= totalCount;

          const tbody = document.querySelector("#listTable tbody");
          tbody.innerHTML = "";

          if (!data.items || data.items.length === 0) {
            tbody.innerHTML =
              "<tr><td colspan='4' style='text-align:center; padding: 30px;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
          }

          // [ìˆ˜ì •ë¨] ëª©ë¡ í…Œì´ë¸” í‘œì‹œ (.toFixed(2) ì ìš©)
          const rows = data.items
            .map((item) => {
              let firstResultStr = "-";
              if (item.topk && item.topk.length > 0) {
                // [ìˆ˜ì •] ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œì‹œ
                firstResultStr = `${item.topk[0].label} (${(item.topk[0].score * 100).toFixed(2)}%)`;
              }

              return `<tr>
                <td><span class="clickable-id" onclick="clickId('${item.id}')">${item.id}</span></td>
                <td>${item.model_name}</td>
                <td>${item.original_filename}</td>
                <td>${firstResultStr}</td>
            </tr>`;
            })
            .join("");

          tbody.innerHTML = rows;
        } catch (error) {
          console.error(error);
        }
      }

      function applyManualSkip() {
        const input = document.getElementById("skipInput");
        let val = parseInt(input.value);

        if (isNaN(val) || val < 0) {
          val = 0;
        }

        currentSkip = val;
        loadList();
      }

      function changePage(direction) {
        const newSkip = currentSkip + direction * LIMIT;
        if (newSkip < 0) return;

        currentSkip = newSkip;
        loadList();
      }

      function clickId(id) {
        document.getElementById("searchIdInput").value = id;
        searchById();
        document
          .getElementById("searchIdInput")
          .scrollIntoView({ behavior: "smooth" });
      }

      // ì´ˆê¸° ë¡œë”©
      loadList();
    </script>
  </body>
</html>
